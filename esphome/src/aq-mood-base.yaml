#aq-mood base file


# Enable logging
logger:
#  level: VERBOSE


external_components:
#  - source: tos_components/components
  - source:
      type: git
      url: https://github.com/tuct/esphome_external_components
      ref: main  
    refresh: 1800s
i2c:
  sda: ${pin_sda}
  scl: ${pin_scl}
spi:
  clk_pin: ${pin_clk}
  mosi_pin: ${pin_mosi}
font:
  - file: "gfonts://Rubik@400"
    id: font_label_rh
    size: 8
    bpp: 4
    glyphs: [
       H,R,"%"
      ]
  - file: "gfonts://Rubik@400"
    id: font_label_labels
    size: 12
    bpp: 4
    glyphs: [
       "¬µ","¬≥","/","¬∞",".","%",P,M,I,E,G,U,V,O,C,d,g,m,p,h,c,n,l,t,a,e,x,o,v,r,y,i,s,"0","1","2","5"
      ]
  - file: "gfonts://Rubik@500"
    id: font_label_labels_bold
    size: 13
    bpp: 4
    glyphs: [
       "¬µ","¬≥","/","¬∞",".","%",P,M,I,E,G,U,V,O,C,d,g,m,p,h,c,n,l,t,a,e,x,o,v,r,y,i,s,"0","1","2","5"
      ]
  - file: "gfonts://Rubik@500"
    id: font_label_labels_bolder
    size: 15
    bpp: 4
    glyphs: [
       "¬µ","¬≥","/","¬∞",".","%",P,M,I,E,G,U,V,O,C,d,g,m,p,h,c,n,l,t,a,e,x,o,v,r,y,i,s,"0","1","2","5"," ","4"
      ]
  - file: "gfonts://Rubik@500"
    id: font_label_labels_big
    size: 22
    bpp: 4
    glyphs: [
       "¬∞",c,C,"%"
      ]
  - file: "gfonts://Rubik@400"
    id: font_label_numbers
    size: 16
    bpp: 4
    glyphs: [
      "0","1","2","3","4","5","6","7","8","9", ".","N","a","n"
      ]
  - file: "gfonts://Rubik@400"
    id: font_label_numbers_big
    size: 28
    bpp: 4
    glyphs: [
      "0","1","2","3","4","5","6","7","8","9", ".","N","a","n"
      ]
  - file: "gfonts://Rubik@500"
    id: font_label_headline
    size: 18
    bpp: 4
    glyphs: [
      N,X,Q,O,P,V,C,a,c,e,i,l,r,s,t,M,I,E,G,U,d,g,m,p,h,k,n,x,o,v,y,"."," ","2","¬∞",
      ]
  - file: "gfonts://Noto+Emoji@600"
    id: font_emoji
    size: 90
    bpp: 4
    glyphs: [
      üòÄ,üòè,üôÑ,üò°,ü§¨,üí¨
      ]
  - file: "gfonts://Noto+Emoji@700"
    id: font_emoji_small
    size: 50
    bpp: 4
    glyphs: [
      üòÄ,üòè,üôÑ,üò°,ü§¨,üí¨
      ]
  - file: "gfonts://Noto+Emoji@700"
    id: font_emoji_temp
    size: 30
    bpp: 4
    glyphs: [
      "üå°Ô∏è","üíß","üóú"
      ]
display:
  - platform: ili9xxx
    model: "ST7735" # 1.8"
    #color_order: rgb  # 2.8"
    #model: "ILI9341" # 2.8"
    id: my_display
    reset_pin: ${pin_reset} 
    cs_pin: ${pin_cs} 
    dc_pin: ${pin_dc} 
    rotation: 180
    invert_colors: false
    auto_clear_enabled: false
    #update_interval: 250ms
    dimensions:
      height: 160
      width: 128
script:
  - id: on_boot
    then:
      - delay: 5s
      #trigger set brightness
      - number.set:
          id: ${id_prefix}_status_light_brightness
          value: !lambda return id(${id_prefix}_status_light_brightness).state;
      #set last screen
      - delay: 5s
      - select.set:
          id: ${id_prefix}_screen_select
          option: !lambda |-
            auto last = id(${id_prefix}_screen_select).state.c_str();
            if(last)return last;
            return "Emojis - Overview";

lvgl:
  style_definitions:
    - id: default_obj      
      bg_color: 0x000000
      border_width: 0
      border_color: 0xFFFFFF
      pad_all: 0
      radius: 0
      text_color: 0xFFFFFF   
    - id: top_info
      text_color: 0xFFFFFF
      align: RIGHT_MID
      text_align: RIGHT
      pad_right: 1
      text_font: font_label_labels 
    - id: default_obj_emoji      
      bg_color: 0x030303
      border_width: 0
      border_color: 0xFFFFFF
      pad_all: 0
      radius: 0
      text_color: 0xFFFFFF
    - id: cat_label      
      pad_top: 7px
      text_color: 0xFFFFFF
    - id: cat_label_top      
      pad_top: 6px
      translate_y: -1px
      text_color: 0xFFFFFF
    - id: cat_label_text      
      text_color: 0xFFFFFF
      text_font: font_label_labels_bolder 
    - id: cat_label_text_top      
      translate_y: 4px
  gradients:
    - id: color_bar
      direction: hor
      dither: none
      stops:
        - color: 0x189600
          position: 0
        - color: 0x209600
          position: 50
        - color: 0xFDFD00
          position: 128
        - color: 0xDD2000
          position: 210
        - color: 0xFF0000
          position: 255   
  pages:
    - id: welcome
      bg_color: 0x333333
      skip: true 
      widgets:
        - obj:
            align: CENTER
            width: 128
            height: 160
            scrollbar_mode: "OFF"
            styles: 
              - default_obj_emoji
            layout:
              type: grid
              grid_row_align: SPACE_EVENLY
              grid_rows: [110px,25px,25px]
              grid_columns: [128px]
              pad_row: 0
              pad_column: 0
            widgets:
              - label:
                  grid_cell_row_pos: 0
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  align: CENTER
                  id: lbl_loading
                  recolor: true
                  text_font: font_emoji
                  text: "#FFFFFF üí¨#"
              - label:
                  grid_cell_row_pos: 1
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: START
                  align: TOP_MID
                  recolor: true
                  text_font: font_label_headline
                  text: "#FFFFFF aQmood#"
              - label:
                  grid_cell_row_pos: 2
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: START
                  align: TOP_MID
                  recolor: true
                  text_font: font_label_headline
                  text: "#FFFFFF loading...#"
    - id: emoji_page
      bg_color: 0x333333
      widgets:
        - obj:
            align: CENTER
            width: 128
            height: 160
            scrollbar_mode: "OFF"
            styles: 
              - default_obj_emoji
            layout:
              type: grid
              grid_row_align: SPACE_EVENLY
              grid_rows: [128px,32px]
              grid_columns: [128px]
              pad_row: 0
              pad_column: 0
            widgets:
              - label:
                  grid_cell_row_pos: 0
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  align: CENTER
                  id: lbl_emoji
                  recolor: true
                  text_font: font_emoji
                  text: "#FF0000 ü§¨#"
              - label:
                  grid_cell_row_pos: 1
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: START
                  align: TOP_MID
                  id: lbl_emoji_text
                  recolor: true
                  text_font: font_label_headline
                  text: "#${color_unhealthy} Unhealthy#"
    - id: emoji_page_details
      bg_color: 0x333333
      widgets:
        - obj:
            align: CENTER
            width: 128
            height: 160
            scrollbar_mode: "OFF"
            styles: 
              - default_obj_emoji
            layout:
              type: grid
              grid_row_align: SPACE_EVENLY
              grid_rows: [80px,80px]
              grid_columns: [64px,64px]
              pad_row: 0
              pad_column: 0
            widgets:
              - obj:
                  grid_cell_row_pos: 1
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  align: CENTER
                  width: 64
                  height: 80
                  scrollbar_mode: "OFF"
                  styles: 
                    - default_obj
                    - cat_label      
                  widgets:
                    - label:
                        align: TOP_MID
                        id: lbl_emoji_top_left
                        recolor: true
                        text_font: font_emoji_small
                        text: "#FF0000 ü§¨#"                 
                    - label:
                        align: BOTTOM_MID
                        text: "VOC"  
                        styles: cat_label_text     
              - obj:
                  grid_cell_row_pos: 1
                  grid_cell_column_pos: 1
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  align: CENTER
                  width: 64
                  height: 80
                  scrollbar_mode: "OFF"
                  styles: 
                    - default_obj
                    - cat_label      
                  widgets:                        
                    - label:
                        align: TOP_MID
                        id: lbl_emoji_top_right
                        recolor: true
                        text_font: font_emoji_small 
                        text: "#FF0000 üò°#"   
                    - label:
                        align: BOTTOM_MID
                        text: "CO2"  
                        styles: cat_label_text     
              - obj:
                  grid_cell_row_pos: 0
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  grid_cell_column_span: 2
                  align: CENTER
                  width: 128
                  height: 90
                  scrollbar_mode: "OFF"
                  styles: 
                    - default_obj
                    - cat_label_top   
                  widgets:               
                    - label:
                        align: CENTER
                        id: lbl_emoji_top
                        recolor: true
                        text_font: font_emoji_small
                        text: "#FDFD00 üôÑ#"
                    - label:
                        align: BOTTOM_MID
                        text: "PM 2.5"  
                        styles: 
                          - cat_label_text
                          - cat_label_text_top          
    - id: aq_details_particles
      bg_color: 0x000000
      widgets:
        - obj:
            align: CENTER
            width: 128
            height: 160
            scrollbar_mode: "OFF"
            styles: 
              - default_obj
            layout:
              type: grid
              grid_row_align: SPACE_EVENLY
              grid_rows: [50px, 40px, 40px,30px]
              grid_columns: [64px, 64px]
              pad_row: 0
              pad_column: 0       
            widgets:
              - obj:
                  grid_cell_row_pos: 0
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  grid_cell_column_span: 2
                  align: CENTER
                  width: 128
                  height: 50
                  scrollbar_mode: "OFF"
                  styles: 
                    - default_obj     
                  border_width: 1
                  border_side: BOTTOM
                  pad_bottom: 4px
                  widgets:          
                    - label:
                        align: CENTER
                        text_font: font_label_headline
                        text: "Particles"
                        id: aq_details_particles_headline
                    - label:
                        align: BOTTOM_MID
                        text_font: font_label_labels_bolder
                        text: "¬µg/m¬≥"  

              - obj:
                  grid_cell_row_pos: 1
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  align: CENTER
                  width: 64
                  height: 40
                  scrollbar_mode: "OFF"
                  styles: 
                    - default_obj      
                  widgets:
                    - label:
                        align: TOP_MID
                        text_font: font_label_labels_bolder
                        text: "PM 1.0"       
                    - label:
                        align: BOTTOM_MID
                        text_font: font_label_numbers
                        text: "1234"
                        id: aq_details_particles_pm1
                        recolor: true   
              - obj:
                  grid_cell_row_pos: 1
                  grid_cell_column_pos: 1
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  align: CENTER
                  width: 64
                  height: 40
                  scrollbar_mode: "OFF"
                  styles: 
                    - default_obj      
                  widgets:
                    - label:
                        align: TOP_MID
                        text_font: font_label_labels_bolder
                        text: "PM 2.5"   
                    - label:
                        align: BOTTOM_MID
                        text_font: font_label_numbers
                        text: "1234"   
                        id: aq_details_particles_pm25
                        recolor: true  

              - obj:
                  grid_cell_row_pos: 2
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  align: CENTER
                  width: 64
                  height: 40
                  scrollbar_mode: "OFF"
                  styles: 
                    - default_obj      
                  widgets:
                    - label:
                        align: TOP_MID
                        text_font: font_label_labels_bolder
                        text: "PM 4.0"   
                    - label:
                        align: BOTTOM_MID
                        text_font: font_label_numbers
                        text: "1234"  
                        id: aq_details_particles_pm4
                        recolor: true  
 
              - obj:
                  grid_cell_row_pos: 2
                  grid_cell_column_pos: 1
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  align: CENTER
                  width: 64
                  height: 40
                  scrollbar_mode: "OFF"
                  styles: 
                    - default_obj      
                  widgets:
                    - label:
                        align: TOP_MID
                        text_font: font_label_labels_bolder
                        text: "PM 10.0"   
                    - label:
                        align: BOTTOM_MID
                        text_font: font_label_numbers
                        text: "1234"  
                        id: aq_details_particles_pm10
                        recolor: true  
              - obj:
                  grid_cell_row_pos: 3
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  grid_cell_column_span: 2
                  align: CENTER
                  styles:
                    - default_obj
                  width: 128
                  height: 30
                  scrollbar_mode: "OFF"                  
                  widgets:     
                    - obj:
                        align: TOP_LEFT
                        styles:
                          - default_obj
                        scrollbar_mode: "OFF"
                        width: 128
                        height: 11
                        widgets:
                          - obj:
                              align: CENTER
                              bg_grad: color_bar
                              styles:
                                - default_obj
                              radius: 3
                              width: 106
                              height: 5
                          - obj:
                              id: prog_bar_pm_2
                              align: CENTER
                              styles:
                                - default_obj
                              pad_left: 50
                              height: 11
                              width: 106
                              scrollbar_mode: "OFF"
                              bg_opa: TRANSP
                              opa_layered: 100%
                              widgets:
                                - obj:
                                    align: LEFT_MID
                                    border_width: 2
                                    border_color: 0x06639c
                                    bg_color: 0xFDFD00  
                                    bg_opa: TRANSP
                                    styles:
                                      - default_obj
                                    radius: 3
                                    width: 6
                                    height: 11    
                                    opa_layered: 100%                          
                    - label:
                        text: '...'
                        align: CENTER
                        text_align: CENTER
                        recolor: true
                        text_font: font_label_labels_bold
                        id: prog_bar_pm_text_2
                        pad_top: 5
    - id: aq_details_co2_vox_nox
      bg_color: 0x000000
      widgets:
        - obj:
            align: CENTER
            width: 128
            height: 160
            scrollbar_mode: "OFF"
            styles: 
              - default_obj
            layout:
              type: grid
              grid_row_align: SPACE_EVENLY
              grid_rows: [10px,21px,29px,21px,29px,21px,29px]
              grid_columns: [128px]
              pad_row: 0
              pad_column: 0
            widgets:    
              - obj:
                  grid_cell_row_pos: 0
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  height: 10px
                  styles: 
                    - default_obj
                  scrollbar_mode: "OFF"
              - obj:
                  grid_cell_row_pos: 1
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  height: 21px
                  styles: 
                    - default_obj
                  scrollbar_mode: "OFF"
                  text_font: font_label_headline
                  widgets:
                    - label:
                        text: 'PM'
                        align: TOP_LEFT
                        text_align: LEFT
                        pad_left: 3
                        id: lbl_pm25_2_header
                    - label:
                        text: '¬µg/m¬≥'
                        align: TOP_RIGHT
                        text_align: RIGHT
                        text_font: font_label_labels_bold
                        text_color: 0xFFFFFF
                        pad_top: 3
                        pad_right : 5
                    - obj:
                        width: 42
                        x: 42
                        height: 20
                        styles: 
                          - default_obj
                        scrollbar_mode: "OFF"
                        widgets:
                          - label:
                              text: '...'
                              id: lbl_pm25_2
                              align: TOP_MID
                              text_align: CENTER
                              text_font: font_label_numbers
                              y: 2          
              - obj:
                  grid_cell_row_pos: 2
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  height: 29px
                  styles: 
                    - default_obj
                  scrollbar_mode: "OFF"
                  text_font: font_label_headline
                  border_width: 1
                  border_side: BOTTOM
                  widgets:
                    - obj:
                        align: TOP_LEFT
                        styles:
                          - default_obj
                        scrollbar_mode: "OFF"
                        width: 128
                        height: 11
                        widgets:
                          - obj:
                              align: CENTER
                              bg_grad: color_bar
                              styles:
                                - default_obj
                              radius: 3
                              width: 106
                              height: 5
                          - obj:
                              id: prog_bar_pm25_2
                              align: CENTER
                              styles:
                                - default_obj
                              pad_left: 50
                              height: 11
                              width: 106
                              scrollbar_mode: "OFF"
                              bg_opa: TRANSP
                              opa_layered: 100%
                              widgets:
                                - obj:
                                    align: LEFT_MID
                                    border_width: 2
                                    border_color: 0x06639c
                                    bg_color: 0xFDFD00  
                                    bg_opa: TRANSP
                                    styles:
                                      - default_obj
                                    radius: 3
                                    width: 6
                                    height: 11    
                                    opa_layered: 100%
                    - label:
                        text: '...'
                        align: CENTER
                        text_align: CENTER
                        text_font: font_label_labels_bold
                        id: prog_bar_pm25_2_text
                        recolor: true
                        pad_top: 5 
                    - label:
                        text: '2.5'
                        align: LEFT_MID
                        text_align: LEFT
                        text_font: font_label_labels
                        pad_top: 7 
                        pad_left: 5
              - obj:
                  grid_cell_row_pos: 3
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  height: 21px
                  styles: 
                    - default_obj
                  scrollbar_mode: "OFF"
                  text_font: font_label_headline
                  widgets:
                    - label:
                        text: 'VOC'
                        align: TOP_LEFT
                        text_align: LEFT
                        pad_left: 3
                        id: lbl_voc_header
                    - label:
                        text: 'Index'
                        align: TOP_RIGHT
                        text_align: RIGHT
                        text_font: font_label_labels_bolder
                        text_color: 0xFFFFFF
                        pad_top: 3
                        pad_right : 5
                    - obj:
                        width: 42
                        x: 42
                        height: 20
                        styles: 
                          - default_obj
                        scrollbar_mode: "OFF"
   
                        widgets:
                          - label:
                              text: '...'
                              id: lbl_voc
                              align: TOP_MID
                              text_align: CENTER
                              text_font: font_label_numbers
                              y: 2          
              - obj:
                  grid_cell_row_pos: 4
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  height: 29px
                  styles: 
                    - default_obj
                  scrollbar_mode: "OFF"
                  text_font: font_label_headline
                  border_width: 1
                  border_side: BOTTOM
                  widgets:
                    - obj:
                        align: TOP_LEFT
                        styles:
                          - default_obj
                        scrollbar_mode: "OFF"
                        width: 128
                        height: 11
                        widgets:
                          - obj:
                              align: CENTER
                              bg_grad: color_bar
                              styles:
                                - default_obj
                              radius: 3
                              width: 106
                              height: 5
                          - obj:
                              id: prog_bar_voc
                              align: CENTER
                              styles:
                                - default_obj
                              pad_left: 50
                              height: 11
                              width: 106
                              scrollbar_mode: "OFF"
                              bg_opa: TRANSP
                              opa_layered: 100%
                              widgets:
                                - obj:
                                    align: LEFT_MID
                                    border_width: 2
                                    border_color: 0x06639c
                                    bg_color: 0xFDFD00   
                                    bg_opa: TRANSP
                                    styles:
                                      - default_obj
                                    radius: 3
                                    width: 6
                                    height: 11    
                                    opa_layered: 100%
                    - label:
                        text: '...'
                        align: CENTER
                        text_align: CENTER
                        text_font: font_label_labels_bold
                        id: prog_bar_voc_text
                        recolor: true
                        pad_top: 5
              - obj:
                  grid_cell_row_pos: 5
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  height: 21px
                  styles: 
                    - default_obj
                  scrollbar_mode: "OFF"
                  text_font: font_label_headline
                  widgets:
                    - label:
                        text: 'CO2'
                        align: TOP_LEFT
                        text_align: LEFT
                        pad_left: 3
                        id: lbl_co2_header
                    - label:
                        text: 'ppm'
                        align: TOP_RIGHT
                        text_align: RIGHT
                        text_font: font_label_labels_bolder
                        text_color: 0xFFFFFF
                        pad_top: 3
                        pad_right : 5
                    - obj:
                        width: 42
                        x: 42
                        height: 20
                        styles: 
                          - default_obj
                        scrollbar_mode: "OFF"
                        widgets:
                          - label:
                              text: '...'
                              id: lbl_co2
                              align: TOP_MID
                              text_align: CENTER
                              text_font: font_label_numbers
                              y: 2          
              - obj:
                  grid_cell_row_pos: 6
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  height: 29px
                  styles: 
                    - default_obj
                  scrollbar_mode: "OFF"
                  text_font: font_label_headline
                  border_width: 1
                  border_side: BOTTOM
                  widgets:
                    - obj:
                        align: TOP_LEFT
                        styles:
                          - default_obj
                        scrollbar_mode: "OFF"
                        width: 128
                        height: 11
                        widgets:
                          - obj:
                              align: CENTER
                              bg_grad: color_bar
                              styles:
                                - default_obj
                              radius: 3
                              width: 106
                              height: 5
                          - obj:
                              id: prog_bar_co2
                              align: CENTER
                              styles:
                                - default_obj
                              pad_left: 50
                              height: 11
                              width: 106
                              scrollbar_mode: "OFF"
                              bg_opa: TRANSP
                              opa_layered: 100%
                              widgets:
                                - obj:
                                    align: LEFT_MID
                                    border_width: 2
                                    border_color: 0x06639c
                                    bg_color: 0xFDFD00  
                                    bg_opa: TRANSP
                                    styles:
                                      - default_obj
                                    radius: 3
                                    width: 6
                                    height: 11    
                                    opa_layered: 100%
                    - label:
                        text: '...'
                        align: CENTER
                        text_align: CENTER
                        text_font: font_label_labels_bold
                        id: prog_bar_co2_text
                        recolor: true
                        pad_top: 5 

    - id: temp_and_co
      bg_color: 0x000000
      widgets:
        - obj:
            align: CENTER
            width: 128
            height: 160
            scrollbar_mode: "OFF"
            styles: 
              - default_obj
            layout:
              type: grid
              grid_row_align: SPACE_EVENLY
              grid_rows: [50px,50px,21px,29px]
              grid_columns: [128px]
              pad_row: 0
              pad_column: 0
            widgets:    
              - obj:
                  grid_cell_row_pos: 0
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  height: 50px
                  styles: 
                    - default_obj
                  scrollbar_mode: "OFF"
                  text_font: font_label_headline
                  widgets:
                    - label:
                        text: "üå°Ô∏è"
                        align: BOTTOM_LEFT
                        text_align: LEFT
                        pad_left: 3
                        text_font: font_emoji_temp
                    - label:
                        text: '¬∞C'
                        align: BOTTOM_RIGHT
                        text_align: RIGHT
                        text_font: font_label_labels_big
                        text_color: 0xFFFFFF
                        pad_top: 5
                        pad_right : 5
                    - obj:
                        align: CENTER
                        height: 50
                        styles: 
                          - default_obj
                        scrollbar_mode: "OFF"
                        bg_opa: TRANSP
                        opa_layered: 100%
                        widgets:
                          - label:
                              text: '...'
                              id: lbl_temp
                              align: BOTTOM_MID
                              text_align: CENTER
                              text_font: font_label_numbers_big
                              y: 2          
              - obj:
                  grid_cell_row_pos: 1
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: START
                  height: 43px
                  styles: 
                    - default_obj
                  scrollbar_mode: "OFF"
                  text_font: font_label_headline
                  widgets:
                    - label:
                        text: "üíß"
                        align: BOTTOM_LEFT
                        text_align: LEFT
                        pad_left: 3
                        text_font: font_emoji_temp
                    - label:
                        text: '%'
                        align: BOTTOM_RIGHT
                        text_align: RIGHT
                        text_font: font_label_labels_big
                        text_color: 0xFFFFFF
                        pad_top: 5
                        pad_right : 5
                    - obj:
                        align: CENTER
                        height: 43
                        styles: 
                          - default_obj
                        scrollbar_mode: "OFF"
                        bg_opa: TRANSP
                        opa_layered: 100%
                        widgets:
                          - label:
                              text: '...'
                              id: lbl_hum
                              align: BOTTOM_MID
                              text_align: CENTER
                              text_font: font_label_numbers_big
                              y: 2         
              - obj:
                  grid_cell_row_pos: 2
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  height: 21px
                  styles: 
                    - default_obj
                  scrollbar_mode: "OFF"
                  text_font: font_label_headline
                  widgets:
                    - label:
                        text: 'NOX'
                        align: TOP_LEFT
                        text_align: LEFT
                        pad_left: 3
                        id: lbl_nox_header
                    - label:
                        text: 'Index'
                        align: TOP_RIGHT
                        text_align: RIGHT
                        text_font: font_label_labels_bolder
                        text_color: 0xFFFFFF
                        pad_top: 3
                        pad_right : 5
                    - obj:
                        width: 42
                        x: 42
                        height: 20
                        styles: 
                          - default_obj
                        scrollbar_mode: "OFF"
                        widgets:
                          - label:
                              text: '...'
                              id: lbl_nox
                              align: TOP_MID
                              text_align: CENTER
                              text_font: font_label_numbers
                              y: 2          
              - obj:
                  grid_cell_row_pos: 3
                  grid_cell_column_pos: 0
                  grid_cell_x_align: CENTER
                  grid_cell_y_align: CENTER
                  height: 29px
                  styles: 
                    - default_obj
                  scrollbar_mode: "OFF"
                  text_font: font_label_headline
                  widgets:
                    - obj:
                        align: TOP_LEFT
                        styles:
                          - default_obj
                        scrollbar_mode: "OFF"
                        width: 128
                        height: 11
                        widgets:
                          - obj:
                              align: CENTER
                              bg_grad: color_bar
                              styles:
                                - default_obj
                              radius: 3
                              width: 106
                              height: 5
                          - obj:
                              id: prog_bar_nox
                              align: CENTER
                              styles:
                                - default_obj
                              pad_left: 50
                              height: 11
                              width: 106
                              scrollbar_mode: "OFF"
                              bg_opa: TRANSP
                              opa_layered: 100%
                              widgets:
                                - obj:
                                    align: LEFT_MID
                                    border_width: 2
                                    border_color: 0x06639c
                                    bg_color: 0xFDFD00  
                                    bg_opa: TRANSP
                                    styles:
                                      - default_obj
                                    radius: 3
                                    width: 6
                                    height: 11    
                                    opa_layered: 100%
                    - label:
                        text: '...'
                        align: CENTER
                        text_align: CENTER
                        text_font: font_label_labels_bold
                        id: prog_bar_nox_text
                        recolor: true
                        pad_top: 5
globals:
   - id: loading_counter
     type: int
     restore_value: no
     initial_value: '0'

interval:
  - interval: 750ms
    then:
      - lvgl.label.update:
          id: lbl_loading
          text: !lambda |-
            auto x = id(loading_counter);
            if(x==0){return "#${color_excellent} üòÄ#";}
            if(x==1){return "#${color_good} üòè#";}
            if(x==2){return "#${color_moderate} üôÑ#";}
            if(x==3){return "#${color_poor} üò°#";}
            if(x==4){return "#${color_unhealthy} ü§¨#";} 
            return "üí¨";
      - lambda: |-
          id(loading_counter)=id(loading_counter)+1;
          auto current = id(loading_counter);
          if( current == 5){
            id(loading_counter)=0;
          }

sensor:
  - platform: template
    id: ${id_prefix}_air_quality_idx_pm
    name: "AQI particles - ${name}" 
    device_class: aqi
    state_class: MEASUREMENT
    lambda: |-
      auto pm25 = id(${id_prefix}_pm25).state;
      if(isnan(pm25)){
        return NAN;
      }
      if(pm25 > ${pm_unhealthy_min}){return 4.0;}
      if(pm25 > ${pm_poor_min}){return 3.0;}
      if(pm25 > ${pm_moderate_min}){return 2.0;}
      if(pm25 > ${pm_good_min}){return 1.0;}
      return 0.0;
    update_interval: 5s
    on_value:
      then:
        - lvgl.widget.update:
            id: 
              - prog_bar_pm_2
              - prog_bar_pm25_2
            pad_left: !lambda |-
              return x*25;
        - lvgl.label.update:
            id: 
              - prog_bar_pm_text_2
              - prog_bar_pm25_2_text
            text: !lambda |-
              if(x==0){return "#${color_excellent} Excellent#";}
              if(x==1){return "#${color_good} Good#";}
              if(x==2){return "#${color_moderate} Moderate#";}
              if(x==3){return "#${color_poor} Poor#";}
              if(x==4){return "#${color_unhealthy} Unhealthy#";}
              return "...";



        - lvgl.widget.update:
            id: 
              - prog_bar_pm_text_2
              - aq_details_particles_headline
              - prog_bar_pm25_2_text
            text_color: !lambda |-
              if(x==0){return lv_color_hex(0x${color_excellent});}
              if(x==1){return lv_color_hex(0x${color_good});}
              if(x==2){return lv_color_hex(0x${color_moderate});}
              if(x==3){return lv_color_hex(0x${color_poor});}
              if(x==4){return lv_color_hex(0x${color_unhealthy});}
              return lv_color_hex(0x${color_excellent} );
  - platform: template
    id: ${id_prefix}_air_quality_idx_voc
    name: "AQI VOC - ${name}"
    device_class: aqi
    state_class: MEASUREMENT
    lambda: |-
      auto voc =  id(${id_prefix}_voc).state;
      if(isnan(voc)){
        return NAN;
      }
      if(voc > ${voc_unhealthy_min}){return 4.0;}
      if(voc > ${voc_poor_min}){return 3.0;}
      if(voc > ${voc_moderate_min}){return 2.0;}
      if(voc > ${voc_good_min}){return 1.0;}
      return 0.0;
    update_interval: 5s
    on_value:
      then:
        - lvgl.widget.update:
            id: prog_bar_voc
            pad_left: !lambda |-
              return x*25;
        - lvgl.label.update:
            id: prog_bar_voc_text
            text: !lambda |-
              if(x==0){return "#${color_excellent} Excellent#";}
              if(x==1){return "#${color_good} Good#";}
              if(x==2){return "#${color_moderate} Moderate#";}
              if(x==3){return "#${color_poor} Poor#";}
              if(x==4){return "#${color_unhealthy} Unhealthy#";}
              return "...";
        - lvgl.widget.update:
            id: lbl_voc
            text_color: !lambda |-
              if(x==0){return lv_color_hex(0x${color_excellent});}
              if(x==1){return lv_color_hex(0x${color_good});}
              if(x==2){return lv_color_hex(0x${color_moderate});}
              if(x==3){return lv_color_hex(0x${color_poor});}
              if(x==4){return lv_color_hex(0x${color_unhealthy});}
              return lv_color_hex(0x000000);
  - platform: template
    id: ${id_prefix}_air_quality_idx_co2
    name: "AQI CO2 - ${name}"
    device_class: aqi
    state_class: MEASUREMENT
    lambda: |-
      auto co2 =  id(${id_prefix}_co2).state;
      if(isnan(co2)){
        return NAN;
      }
      if(co2 > ${co2_unhealthy_min}){return 4.0;}
      if(co2 > ${co2_poor_min}){return 3.0;}
      if(co2 > ${co2_moderate_min}){return 2.0;}
      if(co2 > ${co2_good_min}){return 1.0;}
      return 0.0;
    update_interval: 5s
    on_value:
      then:
        - lvgl.widget.update:
            id: 
              - prog_bar_co2
            pad_left: !lambda |-
              return x*25;
        - lvgl.label.update:
            id: 
              - prog_bar_co2_text
            text: !lambda |-
              if(x==0){return "#${color_excellent} Excellent#";}
              if(x==1){return "#${color_good} Good#";}
              if(x==2){return "#${color_moderate} Moderate#";}
              if(x==3){return "#${color_poor} Poor#";}
              if(x==4){return "#${color_unhealthy} Unhealthy#";}
              return "...";
  - platform: template
    id: ${id_prefix}_air_quality_idx_nox
    name: "AQI NOX - ${name}"
    device_class: aqi
    state_class: MEASUREMENT
    lambda: |-
      auto nox =  id(${id_prefix}_nox).state;
      if(isnan(nox)){
        return NAN;
      }
      if(nox > ${nox_unhealthy_min}){return 4.0;}
      if(nox > ${nox_poor_min}){return 3.0;}
      if(nox > ${nox_moderate_min}){return 2.0;}
      if(nox > ${nox_good_min}){return 1.0;}
      return 0.0;
    update_interval: 5s
    on_value:
      then:
        - lvgl.widget.update:
            id: 
              - prog_bar_nox
            pad_left: !lambda |-
              return x*25;
        - lvgl.label.update:
            id: 
              - prog_bar_nox_text
            text: !lambda |-
              if(x==0){return "#${color_excellent} Excellent#";}
              if(x==1){return "#${color_good} Good#";}
              if(x==2){return "#${color_moderate} Moderate#";}
              if(x==3){return "#${color_poor} Poor#";}
              if(x==4){return "#${color_unhealthy} Unhealthy#";}
              return "...";
  - platform: template
    id: ${id_prefix}_air_quality_idx
    name: "AQI - Air Quality Index - ${name}"
    device_class: aqi
    state_class: MEASUREMENT
    update_interval: 5s
    lambda: |-
      //get max of all 3 aqx
      auto voc = id(${id_prefix}_air_quality_idx_voc).state;
      auto pm =  id(${id_prefix}_air_quality_idx_pm).state;
      auto co2 =  id(${id_prefix}_air_quality_idx_co2).state;
      if(isnan(voc) || isnan(pm)  || isnan(co2) ){
        return NAN;
      }
      if(pm>=voc && pm>=co2){
        return pm;
      }
      if(co2>=voc && co2>=pm){
        return co2;
      } 
      if(voc>=pm && voc>=co2){
        return voc;
      }   
      return NAN;   
 
    on_value:
      then:
        #emojis
        - lvgl.label.update:
            id: lbl_emoji_text
            text: !lambda |-
              auto x = id(${id_prefix}_air_quality_idx).get_state();
              if(x==0){return "#${color_excellent} Excellent#";}
              if(x==1){return "#${color_good} Good#";}
              if(x==2){return "#${color_moderate} Moderate#";}
              if(x==3){return "#${color_poor} Poor#";}
              if(x==4){return "#${color_unhealthy} Unhealthy#";}
              return "let me think";
        - lvgl.label.update:
            id: lbl_emoji
            text: !lambda |-
              auto x = id(${id_prefix}_air_quality_idx).get_state();
              if(x==0){return "#${color_excellent} üòÄ#";}
              if(x==1){return "#${color_good} üòè#";}
              if(x==2){return "#${color_moderate} üôÑ#";}
              if(x==3){return "#${color_poor} üò°#";}
              if(x==4){return "#${color_unhealthy} ü§¨#";} 
              return "üí¨";
        # emojis details
        - lvgl.label.update:
            id: lbl_emoji_top
            text: !lambda |-
              auto x = id(${id_prefix}_air_quality_idx_pm).get_state();
              if(x==0){return "#${color_excellent} üòÄ#";}
              if(x==1){return "#${color_good} üòè#";}
              if(x==2){return "#${color_moderate} üôÑ#";}
              if(x==3){return "#${color_poor} üò°#";}
              if(x==4){return "#${color_unhealthy} ü§¨#";} 
              return "üí¨";
        - lvgl.label.update:
            id: lbl_emoji_top_left 
            text: !lambda |-
              auto x = id(${id_prefix}_air_quality_idx_voc).get_state();
              if(x==0){return "#${color_excellent} üòÄ#";}
              if(x==1){return "#${color_good} üòè#";}
              if(x==2){return "#${color_moderate} üôÑ#";}
              if(x==3){return "#${color_poor} üò°#";}
              if(x==4){return "#${color_unhealthy} ü§¨#";} 
              return "üí¨";
        - lvgl.label.update:
            id: lbl_emoji_top_right
            text: !lambda |-
              auto x = id(${id_prefix}_air_quality_idx_co2).get_state();
              if(x==0){return "#${color_excellent} üòÄ#";}
              if(x==1){return "#${color_good} üòè#";}
              if(x==2){return "#${color_moderate} üôÑ#";}
              if(x==3){return "#${color_poor} üò°#";}
              if(x==4){return "#${color_unhealthy} ü§¨#";} 
              return "üí¨";
  - platform: sen6x
    id: sen54
    pm_1_0:
      name: "PM <1¬µm Weight concentration ${node_name}"
      id: ${id_prefix}_pm10
      accuracy_decimals: 1
      filters:
        - sliding_window_moving_average:
            window_size: 9
            send_every: 1
      on_value:
        then:
          - lvgl.label.update:
              id: aq_details_particles_pm1
              text:
                format: "%.0f"
                args: [ 'x' ]
    pm_2_5:
      name: "PM <2.5¬µm Weight concentration ${node_name}"
      id: ${id_prefix}_pm25
      accuracy_decimals: 1
      filters:
        - sliding_window_moving_average:
            window_size: 9
            send_every: 1
      on_value:
        then:
          - lvgl.label.update:
              id: 
                - aq_details_particles_pm25
                - lbl_pm25_2
              text:
                format: "%.0f"
                args: [ 'x' ]
          
    pm_4_0:
      name: "PM <4¬µm Weight concentration ${node_name}"
      id: ${id_prefix}_pm40
      accuracy_decimals: 1
      on_value:
        then:
          - lvgl.label.update:
              id: aq_details_particles_pm4
              text:
                format: "%.0f"
                args: [ 'x' ]
    pm_10_0:
      name: "PM <10¬µm Weight concentration ${node_name}"
      id: ${id_prefix}_pm100
      accuracy_decimals: 1
      on_value:
        then:
          - lvgl.label.update:
              id: aq_details_particles_pm10
              text:
                format: "%.0f"
                args: [ 'x' ]               
    co2:
      name: "CO2 ${node_name}"
      id: ${id_prefix}_co2
      accuracy_decimals: 1
      on_value:
        then:
          - lvgl.label.update:
              id: lbl_co2
              text:
                format: "%.0f"
                args: [ 'x' ]
    nox:
      name: "NOX ${node_name}"
      id: ${id_prefix}_nox
      accuracy_decimals: 1
      on_value:
        then:
          - lvgl.label.update:
              id: lbl_nox
              text:
                format: "%.0f"
                args: [ 'x' ]
    temperature:
      name: "Temperature top ${node_name}"
      accuracy_decimals: 1
      id: ${id_prefix}_temperature_top
      filters:
        - offset: -4.0
        - sliding_window_moving_average:
            window_size: 15
            send_every: 3
      on_value:
        then:
          - lvgl.label.update:
              id: lbl_temp
              text:
                format: "%.1f"
                args: [ 'x' ]
    humidity:
      name: "Humidity ${node_name}"
      accuracy_decimals: 0
      id: ${id_prefix}_humidity
      on_value:
        then:
          - lvgl.label.update:
              id: lbl_hum
              text:
                format: "%.1f"
                args: [ 'x' ]
    voc:
      name: "VOC ${node_name}"
      id: ${id_prefix}_voc
      algorithm_tuning:
        index_offset: 100
        learning_time_offset_hours: 12
        learning_time_gain_hours: 12
        gating_max_duration_minutes: 180
        std_initial: 50
        gain_factor: 230
      filters:
        - sliding_window_moving_average:
            window_size: 9
            send_every: 1
      on_value:
        then:
          - lvgl.label.update:
              id: lbl_voc
              text:
                format: "%.0f"
                args: [ 'x' ]
    temperature_compensation:
      offset: 0
      normalized_offset_slope: 0
      time_constant: 0
    store_baseline: true
    update_interval: 10s

output:  
  - platform: ledc
    pin: ${pin_backlight}
    id: gpio_backlight 
light:
  - platform: monochromatic
    id: ${id_prefix}_lcd_backlight
    name: ${name} - LCD Backlight
    output: gpio_backlight
    restore_mode: ALWAYS_ON
  - platform: esp32_rmt_led_strip
    chipset: WS2812
    pin: ${pin_argb}
    num_leds: 13
    rgb_order: GRB
    rmt_channel: 0
    restore_mode: ALWAYS_OFF
    id: ${id_prefix}_status_light
    effects:
    - addressable_lambda:
        name: "AirQuality"
        update_interval: 200ms
        lambda: |-

          auto idx = id(${id_prefix}_air_quality_idx).state;
          auto selectColorIdx = Color(0, 0, 50);
          if(idx==0){selectColorIdx = Color(0, 255, 0);}
          if(idx==1){selectColorIdx = Color(128, 255, 0);}
          if(idx==2){selectColorIdx = Color(255, 255, 0);}
          if(idx==3){selectColorIdx = Color(255, 128, 0);}
          if(idx==4){selectColorIdx = Color(255, 0, 0);}
          it.range(3,4) = selectColorIdx;

          //pm 0-2 and 4-6
          auto pm = id(${id_prefix}_air_quality_idx_pm).state;
          auto selectColor = Color(0, 0, 50);
          if(pm==0){selectColor = Color(0, 255, 0);}
          if(pm==1){selectColor = Color(128, 255, 0);}
          if(pm==2){selectColor = Color(255, 255, 0);}
          if(pm==3){selectColor = Color(255, 128, 0);}
          if(pm==4){selectColor = Color(255, 0, 0);}
          it.range(0,3) = selectColor;
          it.range(4,7) = selectColor;

          //voc, 1/2 to 3/4 of leds
          auto voc = id(${id_prefix}_air_quality_idx_voc).state;
          auto selectColorVoc = Color(0, 0, 50);
          if(voc==0){selectColorVoc = Color(0, 255, 0);}
          if(voc==1){selectColorVoc = Color(128, 255, 0);}
          if(voc==2){selectColorVoc = Color(255, 255, 0);}
          if(voc==3){selectColorVoc = Color(255, 128, 0);}
          if(voc==4){selectColorVoc = Color(255, 0, 0);}
          it.range(7,10) = selectColorVoc;

          //co2, last 1/4 of leds
          auto co2 = id(${id_prefix}_air_quality_idx_co2).state;
          auto selectColorCo2 = Color(0, 0, 50);
          if(co2==0){selectColorCo2 = Color(0, 255, 0);}
          if(co2==1){selectColorCo2 = Color(128, 255, 0);}
          if(co2==2){selectColorCo2 = Color(255, 255, 0);}
          if(co2==3){selectColorCo2 = Color(255, 128, 0);}
          if(co2==4){selectColorCo2 = Color(255, 0, 0);}
          it.range(10,13) = selectColorCo2;
binary_sensor:
  - platform: gpio
    pin: 
      number: ${pin_btn}
      mode:
        input: true
        pullup: true
    id: btn
    on_click:
      - min_length: 20ms
        max_length: 500ms
        then:
          - select.next:
              id: ${id_prefix}_screen_select
              cycle: true                                                                                                                                                    
      - min_length: 750ms
        max_length: 5000ms
        then:
          if:
            condition:
              light.is_on: ${id_prefix}_status_light
            then: 
              light.turn_off: ${id_prefix}_status_light
            else:
              - lambda: |-
                  auto call = id(${id_prefix}_status_light).turn_on();
                  //only if below 0.1 ...
                  call.set_brightness(id(${id_prefix}_status_light_brightness).state);
                  call.set_effect("AirQuality");
                  // perform action:
                  call.perform();    
select:
  - platform: template
    name: "Select Screen"
    id: ${id_prefix}_screen_select
    optimistic: true
    options:
      - "Emojis - Overview"
      - "Emojis - PM 2.5, VOC, CO2"
      - "PM 2.5, CO2, VOC"
      - "Temperature, Humidity, NOX"
      - "Particles"
      - "Display off"
    restore_value: true
    on_value:
      then:
        - if:
            condition:  
              lambda: |-
                return strcmp(id(${id_prefix}_screen_select).state.c_str(),"Emojis - Overview") == 0;
            then:
              #need to turn on lighs 
              - light.turn_on: ${id_prefix}_lcd_backlight
              - lvgl.page.show:
                  id: emoji_page
                  animation: FADE_IN
                  time: 500ms
        - if:
            condition:  
                lambda: |-
                  return strcmp(id(${id_prefix}_screen_select).state.c_str(),"Emojis - PM 2.5, VOC, CO2") == 0;
            then:
              - light.turn_on: ${id_prefix}_lcd_backlight
              - lvgl.page.show:
                  id: emoji_page_details
                  animation: FADE_IN
                  time: 500ms
        - if:
            condition:  
                lambda: |-
                  return strcmp(id(${id_prefix}_screen_select).state.c_str(),"Particles") == 0;
            then:
              - light.turn_on: ${id_prefix}_lcd_backlight
              - lvgl.page.show:
                  id: aq_details_particles
                  animation: FADE_IN
                  time: 500ms
        - if:
            condition:  
                lambda: |-
                  return strcmp(id(${id_prefix}_screen_select).state.c_str(),"PM 2.5, CO2, VOC") == 0;
            then:
              - light.turn_on: ${id_prefix}_lcd_backlight
              - lvgl.page.show:
                  id: aq_details_co2_vox_nox
                  animation: FADE_IN
                  time: 500ms
        - if:
            condition:  
                lambda: |-
                  return strcmp(id(${id_prefix}_screen_select).state.c_str(),"Temperature, Humidity, NOX") == 0;
            then:
              - light.turn_on: ${id_prefix}_lcd_backlight
              - lvgl.page.show:
                  id: temp_and_co
                  animation: FADE_IN
                  time: 500ms
        - if:
            condition:  
                lambda: |-
                  return strcmp(id(${id_prefix}_screen_select).state.c_str(),"Display off") == 0;
            then:
              - light.turn_off: ${id_prefix}_lcd_backlight

number:
  - platform: template
    name: "Brightness - ${name}"
    id:  ${id_prefix}_status_light_brightness
    optimistic: true
    min_value: 0
    max_value: 1
    step: 0.25
    restore_value: true
    initial_value: 0.75
    set_action:
      then:
        - logger.log:
            format: "_status_light_brightness %.2f"
            args: [ 'x' ]
        - light.turn_on:
            id:  ${id_prefix}_status_light
            brightness: !lambda "return x;"
            effect: "AirQuality"
